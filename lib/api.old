import '../packages/routinepal_api/lib/models/routine.dart';
import '../packages/routinepal_api/lib/models/summary.dart';
import '../packages/routinepal_api/lib/models/task.dart';
import '../packages/routinepal_api/lib/models/task_group.dart';
import 'package:sqflite/sqflite.dart';

class Api {
  static final Api _instance = Api._();

  factory Api() => _instance;

  Api._();

  Database? _database;

  

  Future<Summary?> getSummary() async {
    final List<Map<String, dynamic>> taskGroups =
        await _database!.query('task_groups');
    final List<Map<String, dynamic>> tasks = await _database!.query('tasks');
    final List<Map<String, dynamic>> routines =
        await _database!.query('routines');

    return Summary(
      taskGroups: taskGroups.map((taskGroup) {
        return TaskGroup(
          id: taskGroup['group_id'],
          name: taskGroup['name'],
          tasks: tasks
              .where((task) => task['task_group_id'] == taskGroup['group_id'])
              .map((task) {
            return Task(
              id: task['task_id'],
              title: task['title'],
              description: task['description'],
            );
          }).toList(),
        );
      }).toList(),
      routines: routines.map((routine) {
        return Routine(
          id: routine['routine_id'],
          title: routine['title'],
          fulfillmentTime: routine['fulfillment_time'],
          tasks: tasks
              .where(
                  (task) => task['task_group_id'] == routine['task_group_id'])
              .map((task) {
            return Task(
              id: task['task_id'],
              title: task['title'],
              description: task['description'],
            );
          }).toList(),
        );
      }).toList(),
      tasks: tasks
          .where((task) =>
              task['task_group_id'] == null &&
              routines.every((routine) =>
                  routine['task_group_id'] != task['task_group_id']))
          .map((task) {
        return Task(
          id: task['task_id'],
          title: task['title'],
          description: task['description'],
        );
      }).toList(),
    );
  }
}
